# Story 1.4: API Gateway Frontend → Backend Python

## Status
**Done**

## Story
**As a** desenvolvedor do sistema,  
**I want** um API Gateway que conecte o frontend Next.js ao backend Python,  
**so that** as requisições sejam roteadas corretamente com fallback automático.

## Acceptance Criteria
1. Gateway deve proxy requisições para backend Python
2. Autenticação Firebase JWT deve ser validada
3. Fallback automático para Supabase se Python offline
4. Endpoints críticos: list-pending, get, update
5. Tratamento de erros robusto
6. Logs estruturados
7. Cliente tipado para frontend
8. Sincronização Supabase após ações no backend

## Tasks / Subtasks
- [x] Task 1: Autenticação cross-platform (AC: 2)
  - [x] firebase-auth.ts
  - [x] Sincronização Supabase → Firebase
  - [x] API /api/auth/sync-firebase
- [x] Task 2: Endpoints webhook (AC: 1,4)
  - [x] /api/webhook/oficios (POST/GET)
  - [x] /api/webhook/oficios/list-pending
  - [x] /api/webhook/oficios/get
- [x] Task 3: Fallback logic (AC: 3,5)
  - [x] Try Python backend first
  - [x] Catch errors
  - [x] Fallback Supabase
  - [x] Log source
- [x] Task 4: Cliente tipado (AC: 7)
  - [x] api-client.ts
  - [x] Tipos TypeScript
  - [x] Métodos helper
- [x] Task 5: Sincronização (AC: 8)
  - [x] Dual write após ações
  - [x] Atualizar Supabase
  - [x] Logs de sync

## Dev Notes

### Arquitetura Híbrida
- **Frontend:** Supabase (auth + db básico)
- **Backend:** Python GCP (IA processing)
- **Gateway:** Next.js API Routes
- **Sync:** Dual Write Firestore ↔ Supabase

### Fluxo de Requisição
```
Frontend → API Route → Try Python Backend
                    ↓ (erro)
                    → Fallback Supabase
```

### Source Tree
```
src/
├── app/api/
│   ├── auth/sync-firebase/route.ts
│   └── webhook/oficios/
│       ├── route.ts
│       ├── list-pending/route.ts
│       └── get/route.ts
└── lib/
    ├── firebase-auth.ts
    ├── python-backend.ts
    └── api-client.ts
```

### Testing
- Testar com backend Python online
- Testar com backend offline (fallback)
- Validar autenticação Firebase
- Testar sincronização
- Verificar logs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story criada retroativamente | Quinn (QA) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes List
- API Gateway completo
- Autenticação cross-platform OK
- Fallback inteligente implementado
- Cliente tipado criado
- Sincronização funcionando

### File List
- `src/lib/firebase-auth.ts`
- `src/lib/python-backend.ts`
- `src/lib/api-client.ts`
- `src/app/api/auth/sync-firebase/route.ts`
- `src/app/api/webhook/oficios/route.ts`
- `src/app/api/webhook/oficios/list-pending/route.ts`
- `src/app/api/webhook/oficios/get/route.ts`
- `API_GATEWAY.md`

## QA Results
*Aguardando revisão QA completa*

