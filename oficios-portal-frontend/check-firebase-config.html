<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #0f0f0f; color: #fff; }
        .container { background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #333; }
        .success { color: #4ade80; font-weight: bold; }
        .error { color: #f87171; font-weight: bold; }
        .warning { color: #fbbf24; font-weight: bold; }
        .info { color: #60a5fa; }
        button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #2563eb; }
        .log { background: #0a0a0a; padding: 15px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 1px solid #333; font-size: 13px; }
        .status { padding: 15px; border-radius: 6px; margin: 10px 0; font-weight: bold; font-size: 18px; text-align: center; }
        .status.success { background: #065f46; color: #4ade80; }
        .status.error { background: #7f1d1d; color: #f87171; }
        .status.warning { background: #78350f; color: #fbbf24; }
        code { background: #333; padding: 2px 8px; border-radius: 4px; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #2a2a2a; color: #60a5fa; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico Completo Firebase</h1>
    
    <div class="container">
        <h2>üìä Status Geral</h2>
        <div id="status" class="status warning">Aguardando diagn√≥stico...</div>
        <div style="text-align: center; margin: 15px 0;">
            <button onclick="runFullDiagnostic()">üîç Executar Diagn√≥stico Completo</button>
            <button onclick="testAuth()">üîê Testar Autentica√ß√£o</button>
            <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
        </div>
    </div>

    <div class="container">
        <h2>üîß Informa√ß√µes do Sistema</h2>
        <table id="systemInfo">
            <tr><th>Propriedade</th><th>Valor</th></tr>
            <tr><td>Dom√≠nio</td><td id="domain">-</td></tr>
            <tr><td>Hostname</td><td id="hostname">-</td></tr>
            <tr><td>Porta</td><td id="port">-</td></tr>
            <tr><td>Protocolo</td><td id="protocol">-</td></tr>
            <tr><td>URL Completa</td><td id="fullurl">-</td></tr>
            <tr><td>User Agent</td><td id="useragent">-</td></tr>
        </table>
    </div>

    <div class="container">
        <h2>üî• Configura√ß√£o Firebase</h2>
        <table id="firebaseConfig">
            <tr><th>Propriedade</th><th>Valor</th></tr>
        </table>
    </div>

    <div class="container">
        <h2>üìù Log Detalhado</h2>
        <div id="log" class="log">Aguardando diagn√≥stico...</div>
    </div>

    <div class="container">
        <h2>üí° Poss√≠veis Solu√ß√µes</h2>
        <div id="solutions"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrE-O9tnox14nsbtkWpbbnCs42_3ewo9M",
            authDomain: "officio-474711.firebaseapp.com",
            projectId: "officio-474711",
            storageBucket: "officio-474711.firebasestorage.app",
            messagingSenderId: "491078993287",
            appId: "1:491078993287:web:b123a486df583bd2693f22",
        };

        let app, auth;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function showSolutions(errorCode) {
            const solutionsDiv = document.getElementById('solutions');
            let solutions = '';

            if (errorCode === 403) {
                solutions = `
                    <div style="background: #7f1d1d; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <h3 style="color: #f87171; margin-top: 0;">‚ùå Erro 403 - Dom√≠nio Bloqueado</h3>
                        <p><strong>Poss√≠veis causas:</strong></p>
                        <ol>
                            <li>O dom√≠nio <code>localhost</code> n√£o foi adicionado no Firebase Console</li>
                            <li>Voc√™ adicionou <code>localhost:3000</code> em vez de <code>localhost</code></li>
                            <li>A configura√ß√£o ainda n√£o propagou (aguarde 1-2 minutos)</li>
                            <li>Voc√™ est√° em um projeto Firebase diferente</li>
                            <li>A API Key est√° incorreta ou restrita</li>
                        </ol>
                        
                        <p><strong>üîß Solu√ß√µes:</strong></p>
                        <ol>
                            <li><strong>Verifique o Firebase Console:</strong>
                                <br>URL: <a href="https://console.firebase.google.com/u/1/project/officio-474711/authentication/settings" target="_blank" style="color: #60a5fa;">Firebase Console</a>
                                <br>V√° em: Authentication ‚Üí Settings ‚Üí Authorized domains
                            </li>
                            <li><strong>Certifique-se que est√° adicionado EXATAMENTE:</strong>
                                <br><code>localhost</code> (SEM porta, SEM http://)
                            </li>
                            <li><strong>Verifique as restri√ß√µes da API Key:</strong>
                                <br>URL: <a href="https://console.cloud.google.com/apis/credentials?project=officio-474711" target="_blank" style="color: #60a5fa;">Google Cloud Console</a>
                                <br>A API Key deve permitir requisi√ß√µes de localhost
                            </li>
                            <li><strong>Limpe o cache:</strong>
                                <br>Pressione Ctrl+Shift+Delete e limpe o cache
                                <br>Recarregue a p√°gina com Ctrl+F5
                            </li>
                            <li><strong>Aguarde propaga√ß√£o:</strong>
                                <br>Ap√≥s adicionar o dom√≠nio, aguarde 1-2 minutos
                            </li>
                        </ol>
                    </div>
                `;
            } else if (errorCode === 200) {
                solutions = `
                    <div style="background: #065f46; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <h3 style="color: #4ade80; margin-top: 0;">‚úÖ Firebase Configurado Corretamente!</h3>
                        <p>A API est√° respondendo corretamente. Voc√™ pode testar a autentica√ß√£o.</p>
                    </div>
                `;
            }

            solutionsDiv.innerHTML = solutions;
        }

        async function runFullDiagnostic() {
            log('üîç ========================================', 'info');
            log('üîç INICIANDO DIAGN√ìSTICO COMPLETO', 'info');
            log('üîç ========================================', 'info');
            
            // 1. Informa√ß√µes do Sistema
            log('\n1Ô∏è‚É£ INFORMA√á√ïES DO SISTEMA:', 'info');
            document.getElementById('domain').textContent = window.location.origin;
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('port').textContent = window.location.port || '(default)';
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('fullurl').textContent = window.location.href;
            document.getElementById('useragent').textContent = navigator.userAgent.substring(0, 100) + '...';
            
            log(`   Dom√≠nio: ${window.location.origin}`, 'info');
            log(`   Hostname: ${window.location.hostname}`, 'info');
            log(`   Porta: ${window.location.port || '(default)'}`, 'info');
            log(`   Protocolo: ${window.location.protocol}`, 'info');
            
            // 2. Configura√ß√£o Firebase
            log('\n2Ô∏è‚É£ CONFIGURA√á√ÉO FIREBASE:', 'info');
            const configTable = document.getElementById('firebaseConfig');
            configTable.innerHTML = '<tr><th>Propriedade</th><th>Valor</th></tr>';
            for (const [key, value] of Object.entries(firebaseConfig)) {
                const row = configTable.insertRow();
                row.insertCell(0).textContent = key;
                row.insertCell(1).innerHTML = `<code>${value}</code>`;
                log(`   ${key}: ${value}`, 'info');
            }
            
            // 3. Teste API Key
            log('\n3Ô∏è‚É£ TESTANDO API KEY:', 'info');
            updateStatus('Testando API Key...', 'warning');
            
            try {
                const response = await fetch(`https://identitytoolkit.googleapis.com/v1/projects?key=${firebaseConfig.apiKey}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                log(`   Status HTTP: ${response.status}`, response.status === 200 ? 'success' : 'error');
                log(`   Status Text: ${response.statusText}`, 'info');
                
                if (response.status === 200) {
                    log('   ‚úÖ API Key V√ÅLIDA!', 'success');
                    updateStatus('‚úÖ API Key v√°lida!', 'success');
                    showSolutions(200);
                } else if (response.status === 403) {
                    log('   ‚ùå ERRO 403: Dom√≠nio n√£o autorizado!', 'error');
                    const text = await response.text();
                    log(`   Resposta: ${text}`, 'error');
                    updateStatus('‚ùå ERRO 403: Dom√≠nio bloqueado!', 'error');
                    showSolutions(403);
                } else if (response.status === 400) {
                    log('   ‚ùå ERRO 400: API Key inv√°lida!', 'error');
                    updateStatus('‚ùå API Key inv√°lida!', 'error');
                } else {
                    log(`   ‚ö†Ô∏è Status inesperado: ${response.status}`, 'warning');
                    updateStatus(`‚ö†Ô∏è Status: ${response.status}`, 'warning');
                }
                
            } catch (error) {
                log(`   ‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                updateStatus('‚ùå Erro na requisi√ß√£o', 'error');
            }
            
            // 4. Inicializar Firebase
            log('\n4Ô∏è‚É£ INICIALIZANDO FIREBASE:', 'info');
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                log('   ‚úÖ Firebase inicializado com sucesso!', 'success');
                log(`   Auth Domain: ${auth.config.authDomain}`, 'info');
            } catch (error) {
                log(`   ‚ùå Erro ao inicializar: ${error.message}`, 'error');
            }
            
            log('\nüîç ========================================', 'info');
            log('üîç DIAGN√ìSTICO COMPLETO', 'success');
            log('üîç ========================================', 'info');
        }

        async function testAuth() {
            if (!auth) {
                log('‚ùå Firebase n√£o inicializado. Execute o diagn√≥stico primeiro.', 'error');
                return;
            }

            log('\nüîê ========================================', 'info');
            log('üîê TESTANDO AUTENTICA√á√ÉO GOOGLE', 'info');
            log('üîê ========================================', 'info');
            updateStatus('Testando autentica√ß√£o...', 'warning');
            
            try {
                const provider = new GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                log('   Abrindo popup de autentica√ß√£o...', 'info');
                const result = await signInWithPopup(auth, provider);
                
                log(`   ‚úÖ LOGIN REALIZADO COM SUCESSO!`, 'success');
                log(`   üë§ Nome: ${result.user.displayName}`, 'success');
                log(`   üìß Email: ${result.user.email}`, 'success');
                log(`   üÜî UID: ${result.user.uid}`, 'info');
                updateStatus('‚úÖ Autentica√ß√£o funcionando!', 'success');
                
            } catch (error) {
                log(`   ‚ùå ERRO NO LOGIN: ${error.message}`, 'error');
                log(`   üîç C√≥digo: ${error.code}`, 'error');
                
                if (error.code === 'auth/requests-from-referer-blocked') {
                    log('   üîß CAUSA: Dom√≠nio n√£o autorizado no Firebase', 'warning');
                    updateStatus('‚ùå Dom√≠nio bloqueado pelo Firebase', 'error');
                    showSolutions(403);
                } else if (error.code === 'auth/popup-blocked') {
                    log('   üîß CAUSA: Popup bloqueado pelo navegador', 'warning');
                    log('   üîß SOLU√á√ÉO: Permita popups para este site', 'warning');
                    updateStatus('‚ùå Popup bloqueado', 'error');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    log('   ‚ÑπÔ∏è Login cancelado pelo usu√°rio', 'info');
                    updateStatus('‚ÑπÔ∏è Login cancelado', 'warning');
                } else {
                    updateStatus(`‚ùå Erro: ${error.code}`, 'error');
                }
            }
            
            log('üîê ========================================', 'info');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Log limpo. Aguardando novo diagn√≥stico...\n';
        }

        // Diagn√≥stico autom√°tico ao carregar
        window.addEventListener('load', () => {
            log('üöÄ P√°gina carregada. Execute o diagn√≥stico completo.', 'info');
        });

        window.runFullDiagnostic = runFullDiagnostic;
        window.testAuth = testAuth;
        window.clearLog = clearLog;
    </script>
</body>
</html>
